<!-- åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ  -->
{% extends 'base.html' %}

{% block title %}é¦–é¡µ - åšåšæ‚ è¿œå›¾ä¹¦åˆ†äº«ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* å¤´éƒ¨æ ·å¼ */
    .header {
        text-align: center;
        padding: 40px 0;
        color: white;
    }

    .brand-title {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .brand-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 5px;
    }

    .brand-english {
        font-size: 1rem;
        opacity: 0.8;
        font-style: italic;
    }

    /* æœç´¢æ¡†æ ·å¼ */
    .search-section {
        background: rgba(255,255,255,0.95);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .search-form {
        display: flex;
        gap: 10px;
        max-width: 800px;
        margin: 0 auto;
    }

    .search-input {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #667eea;
        border-radius: 25px;
        font-size: 16px;
        outline: none;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        border-color: #764ba2;
        box-shadow: 0 0 10px rgba(118, 75, 162, 0.3);
    }

    .search-btn, .like-btn {
        padding: 12px 30px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .search-btn:hover, .like-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* å›¾ä¹¦ç½‘æ ¼æ ·å¼ */
    .books-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .book-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .book-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    .book-title {
        font-size: 1.3rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .book-author {
        color: #7f8c8d;
        font-size: 1rem;
        margin-bottom: 10px;
    }

    .book-publisher, .book-category {
        color: #5d6d7e;
        font-size: 0.95rem;
        margin-bottom: 8px;
    }

    .book-status {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }

    .status-available {
        color: #27ae60;
        font-weight: bold;
    }

    .status-unavailable {
        color: #e74c3c;
        font-weight: bold;
    }

    /* åº•éƒ¨æ ·å¼ */
    .footer {
        text-align: center;
        padding: 30px 0;
        color: white;
        opacity: 0.8;
    }

    .admin-link {
        display: inline-block;
        margin-top: 15px;
        padding: 10px 25px;
        background: rgba(255,255,255,0.2);
        color: white;
        text-decoration: none;
        border-radius: 20px;
        transition: all 0.3s ease;
    }

    .admin-link:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-2px);
    }

    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        color: #7f8c8d;
        grid-column: 1 / -1;
    }

    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: #2c3e50;
    }

</style>
{% endblock %}

{% block content %}
    <div class="container">
        <!-- å¤´éƒ¨å“ç‰Œä¿¡æ¯ -->
        <div class="header">
            <h1 class="brand-title">åšåšæ‚ è¿œï¼Œåˆ†äº«å›¾ä¹¦</h1>
            <div class="brand-subtitle">Bohou distant</div>
            <div class="brand-english">share books</div>
        </div>

        <!-- æœç´¢åŒºåŸŸ -->
        <div class="search-section">
            <form method="get" action="/search/" class="search-form" id="search-form">
                <input type="text" name="q" class="search-input" placeholder="æœç´¢å›¾ä¹¦åç§°ã€ä½œè€…...">
                <button type="submit" class="search-btn">æœç´¢</button>
                <a href="{% url 'recommendations' %}" class="like-btn" target="_blank">çŒœä½ å–œæ¬¢</a>
                <a href="{% url 'login' %}" class="like-btn" target="_blank">ç™»å½•</a>

            </form>
        </div>

<!-- å›¾ä¹¦åˆ—è¡¨ -->
<div class="books-grid">
{% if books %}
    {% for book in books %}
        <div class="book-card">
            <!-- å›¾ä¹¦ä¿¡æ¯éƒ¨åˆ† -->
            <div class="book-info">
                <h3 class="book-title">{{ book.title }}</h3>
                <div class="book-author">ä½œè€…ï¼š{{ book.author }}</div>
                <div class="book-publisher">å‡ºç‰ˆç¤¾ï¼š{{ book.publisher }}</div>
                <div class="book-category">åˆ†ç±»ï¼š{{ book.category_level1 }}</div>
            </div>

            <!-- åº•éƒ¨åŒºåŸŸï¼šçŠ¶æ€å’ŒæŒ‰é’® -->
            <div class="book-footer">
                <div class="book-status">
                    <span class="{% if book.is_available %}status-available{% else %}status-unavailable{% endif %}">
                        {% if book.is_available %}å¯å€Ÿé˜…{% else %}å·²å€Ÿå‡º{% endif %}
                    </span>
                </div>

                <!-- å€Ÿé˜…æŒ‰é’® -->
                <div class="borrow-action">
                    {% if book.is_available %}
                        <button class="borrow-btn"
                                onclick="borrowBook('{{ book.id }}', '{{ book.title|escapejs }}')"
                                data-book-id="{{ book.id }}">
                            ç«‹å³å€Ÿé˜…
                        </button>
                    {% else %}
                        {% if book.current_borrower == user %}
                            <button class="return-btn"
                                    onclick="returnBook('{{ book.id }}')"
                                    data-book-id="{{ book.id }}">
                                å½’è¿˜å›¾ä¹¦
                            </button>
                        {% else %}
                            <button class="borrowed-btn" disabled>
                                å·²å€Ÿå‡º
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <h3>æš‚æ— å›¾ä¹¦æ•°æ®</h3>
        <p>è¯·åˆ°ç®¡ç†åå°æ·»åŠ å›¾ä¹¦ä¿¡æ¯</p>
    </div>
{% endif %}
</div>


        <!-- åº•éƒ¨ -->
        <div class="footer">
            <p>åšåšæ‚ è¿œå›¾ä¹¦åˆ†äº«ç³»ç»Ÿ</p>
            <a href="/admin/" class="admin-link">è¿›å…¥ç®¡ç†åå°</a>
        </div>
    </div>
{% endblock %}







{% block extra_js %}
<script>
// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    // è·å–çŒœä½ å–œæ¬¢æŒ‰é’®
    const guessLikeBtn = document.getElementById('guess-like-btn');
    const recommendationsSection = document.getElementById('recommendations-section');

    // ç»™æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
    if (guessLikeBtn) {
        guessLikeBtn.addEventListener('click', function(e) {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º

            // åˆ‡æ¢æ¨èåŒºåŸŸæ˜¾ç¤º/éšè—
            if (recommendationsSection.style.display === 'none' || recommendationsSection.style.display === '') {
                recommendationsSection.style.display = 'block';
                // å¦‚æœè¿˜æ²¡åŠ è½½è¿‡ï¼Œå°±è·å–æ¨è
                if (document.getElementById('recommendations-list').children.length === 0) {
                    getRecommendations();
                }
            } else {
                recommendationsSection.style.display = 'none';
            }
        });
    }
});

// è·å–æ¨èæ•°æ®
async function getRecommendations() {
    try {
        // è·å–ç”¨æˆ·IDï¼ˆæ ¹æ®ä½ çš„é¡¹ç›®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
        let userId = 'user_001'; // é»˜è®¤ç”¨æˆ·ID

        // å¦‚æœæ˜¯Djangoé¡¹ç›®ï¼Œå¯ä»¥ä»æ¨¡æ¿è·å–ç”¨æˆ·ä¿¡æ¯
        {% if user and user.is_authenticated %}
        userId = '{{ user.id }}';
        {% endif %}

        // æˆ–è€…ä»localStorageè·å–
        const storedUserId = localStorage.getItem('user_id');
        if (storedUserId) {
            userId = storedUserId;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('loading-text').textContent = 'æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–æ¨è...';

        // è°ƒç”¨æ¨èAPI
        const response = await fetch('/api/recommend/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(), // Djangoéœ€è¦CSRF token
            },
            body: JSON.stringify({
                user_id: userId,
                top_n: 6 // æ¨è6æœ¬ä¹¦
            })
        });

        if (!response.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        displayRecommendations(data.recommendations || data.books || []);

    } catch (error) {
        console.error('è·å–æ¨èå¤±è´¥:', error);
        document.getElementById('loading-text').textContent = 'æ¨èåŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
        document.getElementById('loading-text').style.color = '#dc3545';
    }
}

// æ˜¾ç¤ºæ¨èç»“æœ
function displayRecommendations(books) {
    const container = document.getElementById('recommendations-list');
    const loadingText = document.getElementById('loading-text');

    if (!books || books.length === 0) {
        loadingText.textContent = 'æš‚æ— æ¨èï¼Œè¯·å…ˆæµè§ˆä¸€äº›å›¾ä¹¦æˆ–ç™»å½•è´¦æˆ·';
        loadingText.style.color = '#6c757d';
        return;
    }

    // éšè—åŠ è½½æ–‡æœ¬
    loadingText.style.display = 'none';

    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';

    // ç”Ÿæˆå›¾ä¹¦å¡ç‰‡
    books.forEach(book => {
        const bookCard = document.createElement('div');
        bookCard.className = 'book-card recommendation-card';

        // æ„å»ºæè¿°ï¼Œé™åˆ¶é•¿åº¦
        let description = book.description || '';
        if (description.length > 80) {
            description = description.substring(0, 77) + '...';
        }

        // ç¡®å®šå¡ç‰‡é¢œè‰²ï¼ˆæ ¹æ®åˆ†ç±»ï¼‰
        let categoryColor = '#667eea'; // é»˜è®¤è“è‰²
        let categoryIcon = 'ğŸ“š';

        if (book.category && book.category.includes('é©¬å…‹æ€ä¸»ä¹‰')) {
            categoryColor = '#dc3545'; // çº¢è‰²
            categoryIcon = 'ğŸ“–';
        } else if (book.category && book.category.includes('è®¡ç®—æœº')) {
            categoryColor = '#28a745'; // ç»¿è‰²
            categoryIcon = 'ğŸ’»';
        }

        bookCard.innerHTML = `
            <div style="border-left: 4px solid ${categoryColor}; padding-left: 15px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 24px; margin-right: 10px;">${categoryIcon}</span>
                    <h3 class="book-title" style="margin: 0; color: ${categoryColor};">${book.title || 'æœªçŸ¥ä¹¦å'}</h3>
                </div>

                <div class="book-author">ä½œè€…ï¼š${book.author || 'æœªçŸ¥ä½œè€…'}</div>
                <div class="book-publisher">å‡ºç‰ˆç¤¾ï¼š${book.publisher || 'æœªçŸ¥å‡ºç‰ˆç¤¾'}</div>
                ${book.category ? `<div class="book-category">åˆ†ç±»ï¼š${book.category}</div>` : ''}

                ${description ? `
                    <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #666;">
                        ${description}
                    </div>
                ` : ''}

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <div class="book-status">
                        <span class="${book.status === 'å¯å€Ÿé˜…' ? 'status-available' : 'status-unavailable'}">
                            ${book.status === 'å¯å€Ÿé˜…' ? 'âœ… å¯å€Ÿé˜…' : 'âŒ å·²å€Ÿå‡º'}
                        </span>
                    </div>

                    <button onclick="borrowBook('${book.id || book.book_id || ''}', '${(book.title || '').replace(/'/g, "\\'")}')"
                            style="padding: 8px 20px; background: ${book.status === 'å¯å€Ÿé˜…' ? categoryColor : '#6c757d'};
                                   color: white; border: none; border-radius: 25px; cursor: ${book.status === 'å¯å€Ÿé˜…' ? 'pointer' : 'not-allowed'};"
                            ${book.status !== 'å¯å€Ÿé˜…' ? 'disabled' : ''}>
                        ${book.status === 'å¯å€Ÿé˜…' ? 'ç«‹å³å€Ÿé˜…' : 'ä¸å¯å€Ÿ'}
                    </button>
                </div>
            </div>
        `;
        container.appendChild(bookCard);
    });
}

// è·å–CSRF tokenï¼ˆDjangoéœ€è¦ï¼‰
function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }

    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue || '';
}

// å€Ÿé˜…åŠŸèƒ½ - é’ˆå¯¹é¦–é¡µå›¾ä¹¦
function borrowBook(bookId, bookTitle) {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
    {% if not user.is_authenticated %}
        alert('è¯·å…ˆç™»å½•åå†å€Ÿé˜…å›¾ä¹¦');
        window.location.href = '{% url "login" %}?next={{ request.path }}';
        return;
    {% endif %}

    if (!bookId) {
        alert('å›¾ä¹¦IDæ— æ•ˆ');
        return;
    }

    if (!confirm(`ç¡®å®šè¦å€Ÿé˜…ã€Š${bookTitle}ã€‹å—ï¼Ÿ`)) {
        return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const btn = document.querySelector(`[data-book-id="${bookId}"]`);
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = 'å¤„ç†ä¸­...';
        btn.disabled = true;
    }

    // ä¿®æ­£APIè·¯å¾„ï¼šä½¿ç”¨ä½ çš„å®é™…å€Ÿé˜…APIè·¯å¾„
    fetch('{% url "book_borrow" %}', {  // ç¡®ä¿urls.pyä¸­æœ‰è¿™ä¸ªè·¯ç”±
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({
            book_id: bookId,
            book_title: bookTitle
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(`æˆåŠŸå€Ÿé˜…ã€Š${bookTitle}ã€‹ï¼`);
            // åˆ·æ–°å½“å‰é¡µé¢ï¼Œæ›´æ–°å€Ÿé˜…çŠ¶æ€
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            alert(`å€Ÿé˜…å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (btn) {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
    })
    .catch(error => {
        console.error('å€Ÿé˜…è¯·æ±‚å¤±è´¥:', error);
        alert('å€Ÿé˜…è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (btn) {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    });
}
</script>
{% endblock %}