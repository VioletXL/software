{% extends 'base_auth.html' %}

{% block title %}猜你喜欢 - 个性化图书推荐{% endblock %}

{% block extra_css %}
<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px 0;
        background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .book-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        position: relative;
    }

    .book-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }

    .book-cover {
        height: 180px;
        background: linear-gradient(135deg, #3498db, #2c3e50);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 3rem;
    }

    .book-cover.marx {
        background: linear-gradient(135deg, #c0392b, #2c3e50);
    }

    .book-cover.computer {
        background: linear-gradient(135deg, #2c3e50, #3498db);
    }

    .book-info {
        padding: 20px;
    }

    .book-title {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #2c3e50;
        line-height: 1.3;
    }

    .book-meta {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }

    .book-meta i {
        margin-right: 8px;
        color: #3498db;
        width: 16px;
        text-align: center;
    }

    .book-description {
        font-size: 0.9rem;
        color: #777;
        margin: 15px 0;
        line-height: 1.5;
        font-style: italic;
    }

    .book-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
    }

    .status-available {
        background-color: #d4edda;
        color: #155724;
    }

    .status-borrowed {
        background-color: #f8d7da;
        color: #721c24;
    }

    .borrow-btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        width: 100%;
        margin-top: 10px;
    }

    .borrow-btn:hover {
        background-color: #2980b9;
    }

    .borrow-btn:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
    }

    .rating {
        color: #f39c12;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .borrow-count {
        color: #7f8c8d;
        font-size: 0.85rem;
    }

    .actions {
        text-align: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid #ddd;
    }

    .btn {
        display: inline-block;
        padding: 12px 30px;
        background-color: #2c3e50;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: bold;
        margin: 0 10px;
        transition: background-color 0.3s;
        border: none;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #1a252f;
    }

    .btn-primary {
        background-color: #3498db;
    }

    .btn-primary:hover {
        background-color: #2980b9;
    }

    .loading {
        text-align: center;
        padding: 60px;
        font-size: 1.2rem;
        color: #7f8c8d;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .no-results {
        text-align: center;
        padding: 60px;
        color: #7f8c8d;
        font-size: 1.1rem;
    }

    .category-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: rgba(255, 255, 255, 0.9);
        color: #2c3e50;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
        .recommendations-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .header h1 {
            font-size: 2rem;
        }

        .btn {
            display: block;
            margin: 10px auto;
            width: 80%;
            max-width: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1><i class="fas fa-heart"></i> 猜你喜欢</h1>
        <p>根据您的兴趣和阅读历史，为您精心挑选的图书推荐</p>
        {% if user.is_authenticated %}
        <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
            当前用户: {{ user.username }} | <a href="{% url 'logout' %}" style="color: #fff; text-decoration: underline;">退出登录</a>
        </p>
        {% endif %}
    </div>

    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>正在为您生成个性化推荐...</p>
    </div>

    <div id="recommendations-container" style="display: none;">
        <div class="recommendations-grid" id="recommendations-grid">
            <!-- 推荐结果将通过JavaScript动态插入 -->
        </div>

        <div class="actions">
            <a href="{% url 'home' %}" class="btn"><i class="fas fa-home"></i> 返回首页</a>
            <button onclick="refreshRecommendations()" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> 刷新推荐
            </button>
            <a href="{% url 'search' %}" class="btn"><i class="fas fa-search"></i> 搜索更多图书</a>
        </div>
    </div>

    <div id="no-results" class="no-results" style="display: none;">
        <i class="fas fa-book-open" style="font-size: 3rem; margin-bottom: 20px; color: #bdc3c7;"></i>
        <h3>暂无推荐</h3>
        <p>请先浏览一些图书，或登录账户以便我们更好地了解您的兴趣</p>
        {% if not user.is_authenticated %}
        <a href="{% url 'login' %}" class="btn" style="margin-top: 20px;">登录账户</a>
        {% endif %}
        <a href="{% url 'home' %}" class="btn" style="margin-top: 20px;">去首页浏览图书</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 页面加载时获取推荐
    document.addEventListener('DOMContentLoaded', function() {
        getRecommendations();
    });

    // 获取推荐数据
    async function getRecommendations() {
        try {
            // 获取用户ID
            let userId = 'anonymous_user';

            // 如果用户已登录，使用用户ID
            {% if user.is_authenticated %}
            userId = '{{ user.id }}';
            {% endif %}

            console.log('正在获取推荐，用户:', userId);

            // 调用推荐API
            const response = await fetch('{% url "api_recommend" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({
                    user_id: userId,
                    top_n: 12  // 获取12条推荐
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status}`);
            }

            const data = await response.json();
            console.log('推荐数据:', data);

            // 隐藏加载动画
            document.getElementById('loading').style.display = 'none';

            if (data.success && data.recommendations && data.recommendations.length > 0) {
                // 显示推荐容器
                document.getElementById('recommendations-container').style.display = 'block';
                // 显示推荐结果
                displayRecommendations(data.recommendations);
            } else {
                // 显示无结果
                document.getElementById('no-results').style.display = 'block';
            }

        } catch (error) {
            console.error('获取推荐失败:', error);
            document.getElementById('loading').innerHTML = `
                <div style="color: #e74c3c;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>推荐加载失败</h3>
                    <p>${error.message}</p>
                    <button onclick="getRecommendations()" class="btn" style="margin-top: 20px;">
                        <i class="fas fa-redo"></i> 重新尝试
                    </button>
                </div>
            `;
        }
    }

    // 显示推荐结果
    function displayRecommendations(books) {
        const grid = document.getElementById('recommendations-grid');
        grid.innerHTML = '';

        books.forEach(book => {
            // 确定封面样式
            let coverClass = '';
            let coverIcon = 'fa-book';

            if (book.category && book.category.includes('马克思主义')) {
                coverClass = 'marx';
                coverIcon = 'fa-landmark';
            } else if (book.category && book.category.includes('计算机')) {
                coverClass = 'computer';
                coverIcon = 'fa-laptop-code';
            }

            // 构建描述，限制长度
            let description = book.description || '';
            if (description.length > 80) {
                description = description.substring(0, 77) + '...';
            }

            // 安全处理书名和ID
            const safeBookTitle = book.title ? book.title.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
            const safeBookId = book.book_id ? book.book_id.replace(/'/g, "\\'") : (book.id || '');

            const bookCard = document.createElement('div');
            bookCard.className = 'book-card';

            bookCard.innerHTML = `
                <div class="book-cover ${coverClass}">
                    <i class="fas ${coverIcon}" style="font-size: 4rem;"></i>
                </div>

                ${book.category ? `<div class="category-badge">${book.category}</div>` : ''}

                <div class="book-info">
                    <h3 class="book-title">${book.title || '未知书名'}</h3>

                    <div class="book-meta">
                        <i class="fas fa-user"></i>
                        <span>${book.author || '未知作者'}</span>
                    </div>

                    <div class="book-meta">
                        <i class="fas fa-building"></i>
                        <span>${book.publisher || '未知出版社'}</span>
                    </div>

                    ${description ? `
                        <div class="book-description">
                            ${description}
                        </div>
                    ` : ''}

                    <div class="book-stats">
                        <div>
                            ${book.rating ? `<span class="rating">⭐ ${book.rating}</span>` : ''}
                            ${book.borrow_count ? `<br><span class="borrow-count">借阅 ${book.borrow_count}次</span>` : ''}
                        </div>

                        <div>
                            <span class="status-badge ${book.status === '可借阅' ? 'status-available' : 'status-borrowed'}">
                                ${book.status || '状态未知'}
                            </span>
                        </div>
                    </div>

                    <button onclick="borrowBook('${safeBookId}', '${safeBookTitle}')"
                            class="borrow-btn"
                            ${book.status !== '可借阅' ? 'disabled' : ''}>
                        <i class="fas fa-book-reader"></i> ${book.status === '可借阅' ? '立即借阅' : '不可借'}
                    </button>
                </div>
            `;

            grid.appendChild(bookCard);
        });
    }

    // 刷新推荐
    function refreshRecommendations() {
        // 显示加载动画
        document.getElementById('loading').style.display = 'block';
        document.getElementById('recommendations-container').style.display = 'none';
        document.getElementById('no-results').style.display = 'none';

        // 重新获取推荐
        setTimeout(() => {
            getRecommendations();
        }, 500);
    }

    // 借阅图书
    function borrowBook(bookId, bookTitle) {
        if (!bookId || !bookTitle) {
            alert('图书信息不完整');
            return;
        }

        if (!confirm(`确定要借阅《${bookTitle}》吗？`)) {
            return;
        }

        // 检查用户是否登录
        {% if not user.is_authenticated %}
        alert('请先登录后再借阅图书');
        window.location.href = '{% url "login" %}?next={{ request.path }}';
        return;
        {% endif %}

        // 调用借阅API
        fetch('{% url "book_borrow" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                book_id: bookId,
                book_title: bookTitle
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`成功借阅《${bookTitle}》！`);
                // 刷新推荐列表
                refreshRecommendations();
            } else {
                alert(`借阅失败: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('借阅请求失败:', error);
            alert('借阅请求失败，请稍后再试');
        });
    }

    // 获取CSRF token
    function getCsrfToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            return csrfToken.value;
        }

        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue || '';
    }
</script>
{% endblock %}